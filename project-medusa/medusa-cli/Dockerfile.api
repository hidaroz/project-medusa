FROM python:3.9-slim

# Install system dependencies including postgresql-client for pg_isready
RUN apt-get update && apt-get install -y \
    nmap \
    sqlmap \
    git \
    curl \
    wget \
    unzip \
    postgresql-client \
    && rm -rf /var/lib/apt/lists/*

# Install HTTPX (ProjectDiscovery)
RUN HTTPX_VERSION=$(wget -qO- https://api.github.com/repos/projectdiscovery/httpx/releases/latest | grep -oP '"tag_name": "\K(.*)(?=")') && \
    wget -q "https://github.com/projectdiscovery/httpx/releases/download/${HTTPX_VERSION}/httpx_${HTTPX_VERSION#v}_linux_amd64.zip" -O /tmp/httpx.zip && \
    unzip -q /tmp/httpx.zip -d /tmp && \
    mv /tmp/httpx /usr/local/bin/httpx && \
    chmod +x /usr/local/bin/httpx && \
    rm -f /tmp/httpx.zip /tmp/README.md /tmp/LICENSE.md

# Install Amass (OWASP)
RUN AMASS_VERSION=$(wget -qO- https://api.github.com/repos/owasp-amass/amass/releases/latest | grep -oP '"tag_name": "\K(.*)(?=")') && \
    wget -q "https://github.com/owasp-amass/amass/releases/download/${AMASS_VERSION}/amass_linux_amd64.tar.gz" -O /tmp/amass.tar.gz && \
    tar -xzf /tmp/amass.tar.gz -C /tmp && \
    mv /tmp/amass_linux_amd64/amass /usr/local/bin/amass && \
    chmod +x /usr/local/bin/amass && \
    rm -rf /tmp/amass.tar.gz /tmp/amass_linux_amd64

WORKDIR /app/medusa-cli

# Copy current directory (we're already in medusa-cli when building)
COPY . /app/medusa-cli

# Install Python dependencies (now includes langgraph from pyproject.toml)
RUN pip install --upgrade pip && \
    pip install --no-cache-dir . && \
    pip install --no-cache-dir sqlalchemy psycopg2-binary

# Invalidate cache for entrypoint changes
RUN echo "entrypoint build 2025-11-21-v11-with-langgraph"

RUN chmod +x /app/medusa-cli/entrypoint.sh
RUN useradd -m medusa

# Install default configuration for non-interactive deployments
RUN mkdir -p /home/medusa/.medusa && \
    cp config.fly.yaml /home/medusa/.medusa/config.yaml && \
    chown -R medusa:medusa /home/medusa/.medusa

# Note: entrypoint runs as root for database setup, then switches to medusa user context

# Set environment variables
ENV MEDUSA_API_PORT=8000
ENV PORT=8000
ENV PYTHONUNBUFFERED=1

# Expose API port
EXPOSE 8000

# Use entrypoint script for production startup
ENTRYPOINT ["/app/medusa-cli/entrypoint.sh"]
