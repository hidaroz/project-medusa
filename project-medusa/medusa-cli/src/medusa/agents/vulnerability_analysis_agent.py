"""
Vulnerability Analysis Agent

Specialized agent for vulnerability analysis and assessment.
Identifies vulnerabilities, maps to CVEs, and recommends exploitation techniques.
"""

from typing import Dict, Any, List, Optional
from .base_agent import BaseAgent
from .data_models import AgentTask


class VulnerabilityAnalysisAgent(BaseAgent):
    """
    Agent specialized for vulnerability analysis.

    Capabilities:
    - Analyze findings for vulnerabilities
    - Map services to CVEs
    - Assess exploitability
    - Recommend exploitation techniques
    """

    async def _execute_task(self, task: AgentTask) -> Dict[str, Any]:
        """
        Execute vulnerability analysis task.

        Supported task types:
        - analyze_findings
        - map_to_cves
        - assess_exploitability
        """
        task_type = task.task_type

        if task_type == "analyze_findings":
            return await self._analyze_findings(task)
        elif task_type == "map_to_cves":
            return await self._map_to_cves(task)
        elif task_type == "assess_exploitability":
            return await self._assess_exploitability(task)
        else:
            raise ValueError(f"Unknown task type: {task_type}")

    async def _analyze_findings(self, task: AgentTask) -> Dict[str, Any]:
        """
        Analyze reconnaissance findings for vulnerabilities.

        Args:
            task: Task with findings to analyze

        Returns:
            Identified vulnerabilities with CVE mappings
        """
        findings = task.parameters.get('findings', [])
        target = task.parameters.get('target', 'unknown')

        # Get context from fusion engine if available
        context = None
        if self.context_engine:
            context = self.context_engine.build_context_for_vulnerability_analysis(
                findings=findings,
                target=target
            )

        # Build prompt
        prompt = self._build_vuln_analysis_prompt(findings, context)

        # Call LLM
        llm_response = await self._call_llm(prompt, max_tokens=2000)

        # Extract vulnerabilities
        vulnerabilities = self._extract_vulnerabilities(
            findings,
            context,
            llm_response['text']
        )

        result = {
            'vulnerabilities': vulnerabilities,
            'total_found': len(vulnerabilities),
            'high_severity_count': sum(
                1 for v in vulnerabilities
                if v.get('severity') in ['high', 'critical']
            ),
            'context_used': bool(context)
        }

        return result

    async def _map_to_cves(self, task: AgentTask) -> Dict[str, Any]:
        """Map services/software to known CVEs."""
        services = task.parameters.get('services', [])

        # Get CVE context
        context = await self._get_context(
            query=f"CVE for {' '.join(services)}",
            operation_phase="vulnerability_analysis",
            operation_state=task.context
        )

        cve_mappings = []
        if context:
            for rec in context.get('recommendations', []):
                if 'cve' in rec.get('content', '').lower():
                    cve_mappings.append({
                        'cve_id': rec.get('cve_id', 'Unknown'),
                        'service': rec.get('service', 'Unknown'),
                        'severity': rec.get('severity', 'unknown'),
                        'description': rec.get('content', '')
                    })

        return {
            'cve_mappings': cve_mappings,
            'total_cves': len(cve_mappings)
        }

    async def _assess_exploitability(self, task: AgentTask) -> Dict[str, Any]:
        """Assess exploitability of vulnerabilities."""
        vulnerabilities = task.parameters.get('vulnerabilities', [])

        prompt = f"Assess exploitability of these vulnerabilities: {vulnerabilities}"
        llm_response = await self._call_llm(prompt, max_tokens=1500)

        return {
            'assessment': llm_response['text'],
            'exploitable_count': len(vulnerabilities)  # Simplified
        }

    def _build_vuln_analysis_prompt(
        self,
        findings: List[Dict[str, Any]],
        context: Optional[Dict[str, Any]]
    ) -> str:
        """Build prompt for vulnerability analysis."""
        prompt = """You are a vulnerability analysis expert. Analyze these findings for security vulnerabilities:

Findings:
"""

        for i, finding in enumerate(findings, 1):
            service = finding.get('service', 'Unknown')
            version = finding.get('version', 'Unknown')
            port = finding.get('port', 'Unknown')
            prompt += f"{i}. {service} {version} on port {port}\n"

        if context:
            prompt += "\nKnown CVEs from database:\n"
            for cve in context.get('relevant_cves', [])[:5]:
                cve_id = cve.get('cve_id', 'Unknown')
                severity = cve.get('severity', 'unknown')
                desc = cve.get('description', '')[:150]
                prompt += f"- {cve_id} [{severity}]: {desc}\n"

            prompt += "\nExploitation Techniques:\n"
            for tech in context.get('exploitation_techniques', [])[:3]:
                tech_id = tech.get('technique_id', 'Unknown')
                name = tech.get('name', 'Unknown')
                prompt += f"- {tech_id}: {name}\n"

        prompt += """
Provide:
1. List of vulnerabilities found
2. CVE references where applicable
3. Severity assessment
4. Exploitation difficulty
"""

        return prompt

    def _extract_vulnerabilities(
        self,
        findings: List[Dict[str, Any]],
        context: Optional[Dict[str, Any]],
        llm_text: str
    ) -> List[Dict[str, Any]]:
        """Extract structured vulnerability data."""
        vulnerabilities = []

        # Use context CVEs if available
        if context:
            for cve in context.get('relevant_cves', [])[:3]:
                vulnerabilities.append({
                    'vulnerability_type': cve.get('description', '')[:50],
                    'cve_references': [cve.get('cve_id', 'CVE-YYYY-XXXX')],
                    'severity': cve.get('severity', 'medium'),
                    'cvss_score': cve.get('cvss', 0.0),
                    'exploitability': 'medium',
                    'affected_service': 'See CVE details'
                })

        # If no context, create generic vulnerabilities
        if not vulnerabilities:
            for finding in findings:
                vulnerabilities.append({
                    'vulnerability_type': f"Potential vulnerability in {finding.get('service')}",
                    'cve_references': [],
                    'severity': 'unknown',
                    'cvss_score': 0.0,
                    'exploitability': 'unknown',
                    'affected_service': finding.get('service', 'unknown')
                })

        return vulnerabilities
