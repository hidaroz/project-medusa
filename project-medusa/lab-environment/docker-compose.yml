# ============================================================================
# MEDUSA Healthcare Network Simulation Lab
# ============================================================================
# Purpose: Isolated Docker environment for testing AI-driven red team agent
# CAUTION: Contains INTENTIONAL vulnerabilities - DO NOT expose to internet
# ============================================================================

services:
  
  # ==========================================================================
  # 1. EHR FRONTEND (Next.js Application - MedCare EHR System)
  # ==========================================================================
  # Modern React/Next.js frontend for MedCare EHR system
  # This is the PRIMARY user interface for the EHR system
  # Connects to: EHR Backend, EHR API, EHR Redis (via backend)
  # Intentional Vulnerabilities:
  # - Client-side data exposure
  # - Weak authentication (mock login)
  # - XSS vectors in user input
  # - Insecure API calls
  # ==========================================================================
  ehr-webapp-medcare:
    build: ./services/ehr-webapp-medcare
    container_name: medusa_ehr_frontend
    hostname: ehr-frontend
    ports:
      - "8080:3000"     # HTTP access to EHR frontend
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_EHR_API_URL=http://ehr-api:3000
      - NEXT_PUBLIC_EHR_BACKEND_URL=http://ehr-backend:3000
      - NEXT_PUBLIC_API_BASE_URL=http://localhost:3001/api
      - NEXT_PUBLIC_HEALTH_URL=http://localhost:3001/health
      - PORT=3000
    networks:
      - healthcare-dmz
      - healthcare-internal
    depends_on:
      ehr-api:
        condition: service_healthy
      ehr-backend:
        condition: service_healthy
      ehr-redis:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M

  # ==========================================================================
  # 1B. LEGACY PHP WEBAPP (DISABLED - Replaced by Next.js Frontend)
  # ==========================================================================
  # The PHP webapp is kept for reference but disabled
  # Uncomment below if you need to re-enable it for testing
  # ==========================================================================
  # ehr-webapp:
  #   build: ./services/ehr-webapp
  #   container_name: medusa_ehr_web
  #   hostname: ehr-portal-legacy
  #   ports:
  #     - "8081:80"      # Changed port to avoid conflict
  #   environment:
  #     - DB_HOST=ehr-database
  #     - DB_USER=ehrapp
  #     - DB_PASS=Welcome123!
  #     - DB_NAME=healthcare_db
  #   networks:
  #     - healthcare-dmz
  #     - healthcare-internal
  #   depends_on:
  #     - ehr-database
  #   restart: unless-stopped
  #   deploy:
  #     resources:
  #       limits:
  #         cpus: '0.5'
  #         memory: 512M

  # ==========================================================================
  # 2. EHR DATABASE (MySQL)
  # ==========================================================================
  # Contains synthetic patient data with intentional misconfigurations
  # Intentional Vulnerabilities:
  # - Weak root password
  # - Exposed MySQL port
  # - Overly permissive user accounts
  # - Unencrypted sensitive data
  # - Default configurations retained
  # ==========================================================================
  ehr-database:
    image: mysql:8.0
    container_name: medusa_ehr_db
    hostname: db-server
    ports:
      - "3306:3306"    # Intentionally exposed for remote access
    environment:
      - MYSQL_ROOT_PASSWORD=admin123
      - MYSQL_DATABASE=healthcare_db
      - MYSQL_USER=ehrapp
      - MYSQL_PASSWORD=Welcome123!
    volumes:
      - db-data:/var/lib/mysql
      - ./init-scripts/db:/docker-entrypoint-initdb.d
      - db-logs:/var/log/mysql
    networks:
      - healthcare-internal
    command: >
      --general_log=1
      --general_log_file=/var/log/mysql/query.log
      --slow_query_log=1
      --slow_query_log_file=/var/log/mysql/slow.log
      --log_error=/var/log/mysql/error.log
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G

  # ==========================================================================
  # 3. VULNERABLE SSH SERVER
  # ==========================================================================
  # Linux server with SSH access and intentional misconfigurations
  # Intentional Vulnerabilities:
  # - Weak user credentials
  # - Password authentication enabled
  # - Sudo misconfigurations
  # - World-readable sensitive files
  # - Outdated packages simulation
  # - SSH key exposure
  # ==========================================================================
  ssh-server:
    build: ./services/ssh-server
    container_name: medusa_ssh_server
    hostname: admin-workstation
    ports:
      - "2222:22"      # SSH access on non-standard port
    environment:
      - ROOT_PASSWORD=password123
      - USER_NAME=admin
      - USER_PASSWORD=admin2024
      - SUDO_ACCESS=true
    volumes:
      - ssh-logs:/var/log
      - ssh-home:/home
      - ./shared-files:/opt/shared:ro
    networks:
      - healthcare-internal
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.3'
          memory: 256M

  # ==========================================================================
  # 4. FILE SERVER (FTP)
  # ==========================================================================
  # FTP server with medical records and backups
  # Intentional Vulnerabilities:
  # - Anonymous FTP access enabled
  # - Weak credentials
  # - Sensitive files in accessible locations
  # - No encryption (plain FTP)
  # ==========================================================================
  file-server:
    build: ./services/ftp-server
    container_name: medusa_ftp_server
    hostname: file-storage
    ports:
      - "21:21"        # FTP control
      - "21000-21010:21000-21010"  # FTP passive mode range
    environment:
      - FTP_USER=fileadmin
      - FTP_PASS=Files2024!
      - ANONYMOUS_ENABLE=YES
    volumes:
      - ftp-data:/home/ftpuser
      - ftp-logs:/var/log/vsftpd
      - ./mock-data/medical-records:/home/ftpuser/medical_records:ro
    networks:
      - healthcare-internal
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.2'
          memory: 256M

  # ==========================================================================
  # 5. EHR API SERVER (REST API)
  # ==========================================================================
  # REST API backend for EHR system
  # Intentional Vulnerabilities:
  # - Missing authentication on some endpoints
  # - Verbose error messages exposing system info
  # - No rate limiting
  # - JWT with weak secret
  # - CORS misconfiguration
  # ==========================================================================
  ehr-api:
    build: ./services/ehr-api
    container_name: medusa_ehr_api
    hostname: api-server
    ports:
      - "3001:3000"
    environment:
      - DB_HOST=ehr-database
      - DB_USER=ehrapp
      - DB_PASS=Welcome123!
      - DB_NAME=healthcare_db
      - JWT_SECRET=supersecret123
      - NODE_ENV=production
      - LOG_LEVEL=debug
      - REDIS_HOST=ehr-redis
      - REDIS_PORT=6379
    volumes:
      - api-logs:/var/log/api
    networks:
      - healthcare-internal
      - healthcare-dmz
    depends_on:
      - ehr-database
      - ehr-redis
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M

  # ==========================================================================
  # 5B. EHR BACKEND (Business Logic Layer)
  # ==========================================================================
  # Backend service for business logic, authentication, and orchestration
  # Connects EHR frontend with API, database, and cache
  # ==========================================================================
  ehr-backend:
    build: ./services/ehr-api  # Reusing API for now
    container_name: medusa_ehr_backend
    hostname: ehr-backend
    ports:
      - "3002:3000"
    environment:
      - DB_HOST=ehr-database
      - DB_USER=ehrapp
      - DB_PASS=Welcome123!
      - DB_NAME=healthcare_db
      - JWT_SECRET=supersecret123
      - NODE_ENV=production
      - REDIS_HOST=ehr-redis
      - REDIS_PORT=6379
      - API_URL=http://ehr-api:3000
    networks:
      - healthcare-internal
      - healthcare-dmz
    depends_on:
      - ehr-database
      - ehr-redis
      - ehr-api
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M

  # ==========================================================================
  # 5C. EHR REDIS CACHE
  # ==========================================================================
  # Redis cache for session management, caching, and temporary data storage
  # Part of the complete EHR application stack
  # ==========================================================================
  ehr-redis:
    image: redis:7-alpine
    container_name: medusa_ehr_redis
    hostname: ehr-redis
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru --requirepass Welcome123!
    ports:
      - "6380:6379"  # External access for testing (not 6379 to avoid conflict)
    volumes:
      - ehr-redis-data:/data
    networks:
      - healthcare-internal
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: '0.2'
          memory: 256M



  # ==========================================================================
  # 7. NETWORK MONITORING & LOGGING
  # ==========================================================================
  # Centralized logging and monitoring container
  # Collects logs from all services for post-exploitation analysis
  # ==========================================================================
  log-collector:
    build: ./services/log-collector
    container_name: medusa_logs
    hostname: log-server
    ports:
      - "5514:514/udp"  # Syslog
      - "5514:514/tcp"  # Syslog TCP
      - "8081:80"       # Web UI for log viewing
    volumes:
      - centralized-logs:/var/log/collected
      - ./analysis:/var/log/analysis
    networks:
      - healthcare-internal
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.3'
          memory: 384M

  # ==========================================================================
  # 8. VULNERABLE WORKSTATION (Windows-like)
  # ==========================================================================
  # Simulates a Windows workstation using Wine/Linux
  # Intentional Vulnerabilities:
  # - SMB shares with weak permissions
  # - Cached credentials
  # - Unpatched system simulation
  # - Scheduled tasks with elevated privileges
  # ==========================================================================
  workstation:
    build: ./services/workstation
    container_name: medusa_workstation
    hostname: ws-doctor01
    ports:
      - "445:445"      # SMB
      - "3389:3389"    # RDP (simulated)
      - "5900:5900"    # VNC for access
    environment:
      - VNC_PASSWORD=vnc123
      - SMB_USER=doctor
      - SMB_PASS=Doctor2024!
    volumes:
      - workstation-data:/home/doctor
      - workstation-logs:/var/log
      - ./mock-data/documents:/home/doctor/Documents:ro
    networks:
      - healthcare-internal
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M

# ============================================================================
# NETWORK DEFINITIONS
# ============================================================================
# Two-tier network architecture:
# 1. healthcare-dmz: External-facing services (web apps)
# 2. healthcare-internal: Internal services (databases, file servers)
# ============================================================================
networks:
  # DMZ Network - Simulates perimeter network with public-facing services
  healthcare-dmz:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/24
          gateway: 172.20.0.1
    driver_opts:
      com.docker.network.bridge.name: medusa-dmz

  # Internal Network - Simulates internal corporate network
  healthcare-internal:
    driver: bridge
    ipam:
      config:
        - subnet: 172.21.0.0/24
          gateway: 172.21.0.1
    driver_opts:
      com.docker.network.bridge.name: medusa-internal
    internal: false  # Set to true for complete isolation (no internet)

# ============================================================================
# VOLUME DEFINITIONS
# ============================================================================
# Persistent storage for data and logs
# Logs are kept for analysis of MEDUSA's activities
# ============================================================================
volumes:
  # Database volumes
  db-data:
    driver: local
  db-logs:
    driver: local
  
  # Web application volumes
  ehr-logs:
    driver: local
  ehr-uploads:
    driver: local
  
  # API volumes
  api-logs:
    driver: local
  
  # File server volumes
  ftp-data:
    driver: local
  ftp-logs:
    driver: local
  
  # SSH server volumes
  ssh-logs:
    driver: local
  ssh-home:
    driver: local
  
  # LDAP volumes
  ldap-data:
    driver: local
  ldap-config:
    driver: local
  ldap-logs:
    driver: local
  
  # Workstation volumes
  workstation-data:
    driver: local
  workstation-logs:
    driver: local
  
  # Centralized logging
  centralized-logs:
    driver: local
  
  # EHR Redis cache
  ehr-redis-data:
    driver: local

# ============================================================================
# USAGE INSTRUCTIONS
# ============================================================================
# Start the lab:
#   docker-compose up -d
#
# View logs:
#   docker-compose logs -f [service-name]
#
# Stop the lab:
#   docker-compose down
#
# Reset completely (WARNING: destroys all data):
#   docker-compose down -v
#   docker-compose up -d --build
#
# Access services:
#   EHR Frontend (Next.js):    http://localhost:8080
#   EHR API (REST):            http://localhost:3001
#   EHR Backend:               http://localhost:3002
#   EHR Redis Cache:           redis-cli -h localhost -p 6380 -a Welcome123!
#   SSH Server:                ssh admin@localhost -p 2222 (password: admin2024)
#   MySQL Database:            mysql -h localhost -P 3306 -u ehrapp -pWelcome123!
#   FTP File Server:           ftp localhost 21 (user: fileadmin, pass: Files2024!)
#   Log Viewer:                http://localhost:8081
#
# Network inspection:
#   docker network inspect medusa-dmz
#   docker network inspect medusa-internal
# ============================================================================

